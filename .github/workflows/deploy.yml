name: Deploy to GitHub Pages

on:
  push:
    branches: 'master'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        env:
          BASE_PATH: '/${{ github.event.repository.name }}'
        run: |
          bun run build

      - name: Deploy to GitHub Pages
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone the gh-pages branch or create it if it doesn't exist
          git clone --depth=1 --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages-repo || {
            echo "gh-pages branch doesn't exist, creating it..."
            mkdir gh-pages-repo
            cd gh-pages-repo
            git init
            git checkout -b gh-pages
            git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            cd ..
          }

          cd gh-pages-repo

          # Remove all files except pr-preview directory
          find . -maxdepth 1 ! -name 'pr-preview' ! -name '.' ! -name '..' ! -name '.git' -exec rm -rf {} +

          # Copy the built files to root
          cp -r ../build/* .

          # Commit and push
          git add .
          git commit -m "Deploy main site from master branch" || echo "No changes to commit"
          git push origin gh-pages
